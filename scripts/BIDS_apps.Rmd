---
title: "BIDS Apps"
author: "Nandi Vijayakumar"
date: "27 April 2018"
output: html_document
---

```{r, include=FALSE}
#install packages

packages <- c("knitr")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)
```

### Running MRIQC locally using Docker
##### Download mriqc
```{r, engine = 'bash', eval = FALSE}

docker pull poldracklab/mriqc:0.10.4
    #pull image from Docker Hub registry
```

##### Run mriqc
```{r, engine = 'bash', eval = FALSE}

inputdir = '/path/to/input/'  #specify directory where bids formatted data lives
outputdir = '/path/to/input/' #specify output (derivatives) directory

docker run --rm -it \  
    #run container, clean up after container exits, run in interactive mode
  -v ${inputdir}:/data:ro \ 
    #-v gives docker access to the input directory. ro = read only
  -v ${outputdir}:/out \  
    #tell docker where to populate output data.
  poldracklab/mriqc:0.10.4 /data /out participant  
    #specify container image, input folder, output folder, run analyses on participant level

```

### Running MRIQC on HPC using Singularity
##### download_container.sh
```{r, engine = 'bash', eval = FALSE}
#!/bin/bash

#This script creates singulatiry containers for use on HPC. It needs to be run on a local machine (with Docker installed) and then transferred to HPC.

outputdir='/Volumes/psych-cog/dsnlab/BIDS/SingularityContainers'

docker run --privileged -t --rm \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v ${outputdir}:/output \
    singularityware/docker2singularity \
    poldracklab/mriqc:latest \

```

##### batch_mriqc.sh (parallelize mriqc across subjects)
```{r, engine = 'bash', eval = FALSE}
#!/bin/bash
#
# This batch file calls on your subject list (which contains both ID and wave number: SID000,wave1). 
# And runs the job_mriqc.sh file for each subject. 
# It saves the ouput and error files in specified directories.
#
# Set your directories

group_dir=/projects/dsnlab/shared/
container=BIDS/SingularityContainers/poldracklab_mriqc_latest-2017-10-19-8992ca9444b6.img
study="tag"

# Set subject list
SUBJLIST=`cat subject_list.txt`

# Loop through subjects and run job_mriqc
for SUBJ in $SUBJLIST; do

SUBID=`echo $SUBJ|awk '{print $1}' FS=","`
SESSID=`echo $SUBJ|awk '{print $2}' FS=","`
  
sbatch --export subid=${SUBID},sessid=${SESSID},group_dir=${group_dir},study=${study},container=${container} --job-name mriqc --partition=long -n16 --mem=75G --time=20:00:00 -o "${group_dir}"/"${study}"/TAG_scripts/fMRI/ppc/output/"${SUBID}"_"${SESSID}"_mriqc_output.txt -e "${group_dir}"/"${study}"/TAG_scripts/fMRI/ppc/output/"${SUBID}"_"${SESSID}"_mriqc_error.txt job_mriqc.sh
	
done
```

##### job_mriqc.sh (execute mriqc)
```{r, engine = 'bash', eval = FALSE}
#!/bin/bash

# This script runs mriqc on subjects located in the BIDS directory 
# and saves quality control outputs in the derivatives folder.

# Set bids directories
bids_dir="${group_dir}""${study}"/bids_data
derivatives="${bids_dir}"/derivatives/mriqc
working_dir="${derivatives}"/working
image="${group_dir}""${container}"

echo -e "\nMRIQC on ${subid}_${sessid}"
echo -e "\nContainer: $image"
echo -e "\nSubject directory: $bids_dir"

# Load packages
module load singularity

# Create working directory
mkdir -p $working_dir

# Run container using singularity
cd $bids_dir

singularity run --bind "${group_dir}":"${group_dir}" $image $bids_dir $derivatives participant --participant_label $subid --session-id $sessid -w $working_dir --n_procs 16 --mem_gb 64

echo -e "\n"
echo -e "\ndone"
echo -e "\n-----------------------"
```

##### Make sure job_mriqc.sh, batch_mriqc.sh and subject_list.txt are all in same folder. Then run batch script...
```{r, engine = 'bash', eval = FALSE}
sh batch_mriqc.sh
```

```{r, engine = 'bash', eval = FALSE}
image_name bids_dir/ derivatives_dir/ participant 
```


### Running fmriprep locally using Docker
##### Download fmriprep
```{r, engine = 'bash', eval = FALSE}
docker pull poldracklab/fmriprep:latest
    #pull image from Docker Hub registry
```

##### Run fmriprep
```{r, engine = 'bash', eval = FALSE}
inputdir = '/path/to/input/'  #specify directory where bids formatted data lives
outputdir = '/path/to/input/' #specify output (derivatives) directory

docker run --rm -it \  
      #run container, clean up after container exits, run in interactive mode
  -v ${inputdir}:/data:ro \  
      #-v gives docker access to the following directory. ro = read only
  -v ${outputdir}:/out \  
      #tell docker where to populate output data.
  poldracklab/fmriprep:latest /data /out participant  
      #specify container image, input folder, output folder, run analyses on participant level
```

##### Run fmriprep
```{r, engine = 'bash', eval = FALSE}
inputdir = '/path/to/input/'  
outputdir = '/path/to/input/' 

docker run --rm -it \  
  -v ${inputdir}:/data:ro \  
  -v ${outputdir}:/out \  
  poldracklab/fmriprep:latest /data /out participant  
```

##### Run fmriprep without fieldmaps and produce pre-processed images in subject-specific surface space
```{r, engine = 'bash', eval = FALSE}
inputdir = '/path/to/input/'  
outputdir = '/path/to/input/' 

docker run --rm -it \  
  -v ${inputdir}:/data:ro \  
  -v ${outputdir}:/out \  
  poldracklab/fmriprep:latest /data /out participant \ 
  --ignore fieldmaps --output-space fsnative 
      #only additional command line for specifying fmriprep options 
```